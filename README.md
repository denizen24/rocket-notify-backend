## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

`rocket-notify-backend` ‚Äî —Å–µ—Ä–≤–∏—Å –Ω–∞ NestJS, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç Rocket.Chat –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–æ—Å—Ç–µ —á–∏—Å–ª–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram‚Äë–∫–∞–Ω–∞–ª/–±–æ—Ç. –ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ UI. –°–æ–∑–¥–∞–Ω –≤ –≤–∏–¥—É —Ç–æ–≥–æ —á—Ç–æ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Rocket.Chat –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –∏ –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ —á–∞—Ç–æ–≤.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot (/start, /login) ‚Üí NestJS ‚Üí –ë–î (Prisma 7/SQLite) ‚Üí Polling per user ‚Üí –õ–∏—á–Ω—ã–π Telegram —á–∞—Ç
```

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`
2. –ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/login <server> <user> <pass>`
4. –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Rocket.Chat –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ –ë–î

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. `RocketChatPollingService` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `GET /api/v1/subscriptions.get`
   - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (–∫–∞–Ω–∞–ª—ã, –ª–∏—á–Ω—ã–µ, –≥—Ä—É–ø–ø—ã)
   - –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω—ã–π Telegram —á–∞—Ç
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `lastUnread` –≤ –ë–î

## –ú–æ–¥—É–ª–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã

### Core –º–æ–¥—É–ª–∏
- **`AppModule`** ‚Äî –∫–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –º–æ–¥—É–ª–∏
- **`PrismaModule`** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (SQLite —á–µ—Ä–µ–∑ Prisma 7)
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `ConfigModule` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `ConfigService`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `PrismaService` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö
- **`ConfigModule`** ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ `AppModule`)

### Telegram
- **`BotModule`** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegraf –±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TelegrafModule.forRootAsync` —Å `ConfigService`
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `ConfigModule` –≤ –æ–ø—Ü–∏—è—Ö `forRootAsync`
- **`TelegramModule`** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram Bot API
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `ConfigModule` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `ConfigService`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TelegramService`
- **`TelegramService`** ‚Äî –º–µ—Ç–æ–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
  - `sendToUser(chatId, text)` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ª–∏—á–Ω—ã–π —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `sendUnreadAlert(chatId, unreadCount, mentions?)` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö

### Rocket.Chat
- **`RocketChatModule`** ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Rocket.Chat API
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TelegramModule`, `PrismaModule`, `UserModule` (—á–µ—Ä–µ–∑ `forwardRef`)
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `RocketChatService`
- **`RocketChatService`** ‚Äî –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Rocket.Chat:
  - `login(server, user, password)` ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `LoginResult` —Å —Ç–æ–∫–µ–Ω–∞–º–∏
  - `getSubscriptions(server, token, userId, instanceId?)` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
  - `getUnreadCount(server, token, userId, instanceId?)` ‚Äî –ø–æ–¥—Å—á—ë—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
- **`RocketChatPollingService`** ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `UserService` (–∏–∑–±–µ–≥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

### User management
- **`UserModule`** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `PrismaModule`, `RocketChatModule` (—á–µ—Ä–µ–∑ `forwardRef`)
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `UserService`
- **`UserController`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ Telegram –±–æ—Ç–∞:
  - `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  - `/login <server> <user> <pass>` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫—Ä–µ–¥–æ–≤ Rocket.Chat
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@Update()`, `@Command()`, `@Action()` –∏–∑ `nestjs-telegraf`
- **`UserService`** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î:
  - `findOrCreateTelegramUser(telegramId)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `updateRocketChatCreds(telegramId, server, user, pass)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ Rocket.Chat
  - `getAllEnabledUsers()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `updateLastUnread(userId, lastUnread)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  - `toggleEnabled(telegramId, enabled)` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `RocketChatService` (–∏–∑–±–µ–≥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

### –í–µ–±-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
- **`AppController`** ‚Äî REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - `GET /` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  - `GET /healthz` ‚Äî health check (–ø—Ä–æ–≤–µ—Ä–∫–∞ MongoDB –∏ Redis)
  - `GET /users` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
  - `POST /users/:telegramId/enable` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (MongoDB + Mongoose + Typegoose)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MongoDB
- **`src/database/mongo.module.ts`** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MongooseModule.forRootAsync` —Å `ConfigService`
  - URL –ë–î –±–µ—Ä—ë—Ç—Å—è –∏–∑ `DATABASE_URL` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –°—Ö–µ–º–∞ User (Typegoose)
- **`src/database/user.schema.ts`** ‚Äî —Å—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Typegoose
  - –ü–æ–ª—è: `telegramId` (unique), `rcServer`, `rcUser`, `rcToken` (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π), `rcUserId`, `rcInstanceId`, `intervalMin`, `enabled`, `lastUnread`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ timestamps: `createdAt`, `updatedAt`

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –¢–æ–∫–µ–Ω—ã Rocket.Chat —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM
- –°–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `RC_TOKEN_SALT`
- –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CryptoService.decrypt()`

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env)

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `DATABASE_URL` ‚Äî URL MongoDB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `mongodb://admin:password@localhost:27017/rocket-notify?authSource=admin`)
- `MONGO_ROOT_USERNAME` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MongoDB (–¥–ª—è docker-compose)
- `MONGO_ROOT_PASSWORD` ‚Äî –ø–∞—Ä–æ–ª—å MongoDB (–¥–ª—è docker-compose)
- `RC_TOKEN_SALT` ‚Äî —Å–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- `TUNA_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Tuna Tunnel (–¥–ª—è webhook)

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- `PORT` ‚Äî –ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3000)
- `REDIS_URL` ‚Äî URL Redis (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://localhost:6379`)
- `TELEGRAM_WEBHOOK_URL` ‚Äî Tuna tunnel HTTPS URL + `/webhook/rocketnotify` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://xxxx.tuna.am`)
- `TELEGRAM_WEBHOOK_SECRET` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è webhook

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ö—Ä–µ–¥—ã Rocket.Chat —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ, —Ç–æ–∫–µ–Ω—ã –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.

## –¢–∏–ø–∏–∑–∞—Ü–∏—è

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- **`User`** (`src/user/user.types.ts`) ‚Äî –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
- **`UnreadCount`** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (`total`, `channels`, `im`, `groups`)
- **`LoginResult`** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Rocket.Chat (`authToken`, `userId`, `instanceId?`)
- **`Subscription`** ‚Äî –º–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏ Rocket.Chat (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `RocketChatService`)

### –¢–∏–ø–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–º–µ—é—Ç —è–≤–Ω—ã–µ —Ç–∏–ø—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `as Promise<User>` –¥–ª—è –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ Prisma Client
- –í `AppController` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `UserResponse` –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

## –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef()` –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

- **`UserModule` ‚Üî `RocketChatModule`** ‚Äî –æ–±–∞ –º–æ–¥—É–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç `forwardRef` –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
- **`UserService` ‚Üî `RocketChatService`** ‚Äî `UserService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@Inject(forwardRef(() => RocketChatService))`
- **`RocketChatPollingService` ‚Üî `UserService`** ‚Äî `RocketChatPollingService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@Inject(forwardRef(() => UserService))`

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **NestJS 11** ‚Äî —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **MongoDB 7** ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Mongoose 9** ‚Äî ODM –¥–ª—è MongoDB
- **Typegoose 13** ‚Äî —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è Mongoose
- **BullMQ 4** ‚Äî –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ Redis
- **Redis 7** ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π
- **nestjs-telegraf** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram Bot API
- **Tuna Tunnel** ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è webhook
- **Axios** ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Rocket.Chat API
- **TypeScript** ‚Äî —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Docker** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Docker Compose** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `Logger` –∏–∑ NestJS:

- **`RocketChatService`** ‚Äî –ª–æ–≥–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—à–∏–±–æ–∫
- **`RocketChatPollingService`** ‚Äî –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ polling, –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **`UserService`** ‚Äî –ª–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–æ–≤ –∏ –æ—à–∏–±–æ–∫
- **`TelegramService`** ‚Äî –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫

–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤: `[üöÄ Polling started]`, `[‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Rocket.Chat: ...]`, `[üìä Unread: total=...]`, `[üì± Sent alert: ...]`

## –ó–∞–ø—É—Å–∫

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
npm run start:dev
```

### Production
```bash
npm run build
npm run start:prod
```

### Health Check
```bash
curl http://localhost:3000/healthz
```

### –õ–∏–Ω—Ç–µ—Ä
```bash
npm run lint
```

### Docker
```bash
docker-compose up -d
```

## Tuna Tunnel Setup

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [Tuna Tunnel](https://tuna.am/docs/getting-started/?os=docker) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è webhook –æ—Ç Telegram.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Tuna Tunnel

1. **–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω Tuna:**
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [tuna.am](https://tuna.am)
   - –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   # –í .env —Ñ–∞–π–ª–µ
   TUNA_TOKEN=your_tuna_token_here
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:**
   ```bash
   docker-compose up -d
   ```

4. **–ü–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π URL:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Tuna: `docker-compose logs tuna`
   - –ù–∞–π–¥–∏—Ç–µ URL –≤–∏–¥–∞ `https://xxxx.tuna.am`
   - –û–±–Ω–æ–≤–∏—Ç–µ `.env`:
     ```bash
     TELEGRAM_WEBHOOK_URL=https://xxxx.tuna.am
     TELEGRAM_WEBHOOK_SECRET=your_webhook_secret_here
     ```

5. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   docker-compose restart app
   ```

6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook:**
   - –í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è: `üåê Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ Tuna URL: https://xxxx.tuna.am/webhook/rocketnotify`
   - –ï—Å–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è polling —Ä–µ–∂–∏–º

### Fallback –Ω–∞ Polling

–ï—Å–ª–∏ `TELEGRAM_WEBHOOK_URL` –∏–ª–∏ `TELEGRAM_WEBHOOK_SECRET` –Ω–µ —É–∫–∞–∑–∞–Ω—ã, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ polling —Ä–µ–∂–∏–º (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —É Telegram).

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1. –ù–∞–π—Ç–∏ –±–æ—Ç–∞ –≤ Telegram: `@RocketNotifyBot`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/login <server> <user> <pass>`
   - –ü—Ä–∏–º–µ—Ä: `/login https://rocketchat.medcontrol.cloud john pass123`
4. –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–∏—á–Ω—ã–π —á–∞—Ç –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `GET /users` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `POST /users/:telegramId/enable` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ò–Ω—Ç–µ—Ä–≤–∞–ª polling —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ `intervalMin` –≤ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –¢–æ–∫–µ–Ω—ã Rocket.Chat —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM
- `X-Instance-Id` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `lastUnread`)
- –î–ª—è >50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å BullMQ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Webhook –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Tuna Tunnel (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ polling)
- `MongoModule` —è–≤–ª—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `UserController` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `BotModule` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏ `nestjs-telegraf`
- Typegoose —Å—Ö–µ–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `MongooseModule.forFeature` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `getModelForClass(User).schema`
- `trust proxy` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `main.ts` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞ Tuna Tunnel