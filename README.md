## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

`rocket-notify-backend` ‚Äî —Å–µ—Ä–≤–∏—Å –Ω–∞ NestJS –¥–ª—è –º—É–ª—å—Ç–∏–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Rocket.Chat. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞, –≤–≤–æ–¥–∏—Ç —Å–≤–æ–∏ –∫—Ä–µ–¥—ã Rocket.Chat –∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤ –ª–∏—á–Ω—ã–π Telegram —á–∞—Ç.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot (/start, /login) ‚Üí NestJS ‚Üí –ë–î (MongoDB) ‚Üí Polling per user ‚Üí –õ–∏—á–Ω—ã–π Telegram —á–∞—Ç
                                                      ‚Üì
                                            Tuna Tunnel (webhook)
                                                      ‚Üì
                                            –ü—É–±–ª–∏—á–Ω—ã–π HTTPS URL
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Telegram Bot** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`/start`, `/login`)
- **NestJS Backend** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, —Ä–∞–±–æ—Ç–∞ —Å –ë–î, polling
- **MongoDB** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **Redis + BullMQ** ‚Äî –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (>50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **Tuna Tunnel** ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ polling)

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`
2. –ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:
   - **–ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä** (`/setup` –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å"):
     - –®–∞–≥ 1: –í–≤–æ–¥ URL —Å–µ—Ä–≤–µ—Ä–∞ Rocket.Chat
     - –®–∞–≥ 2: –í–≤–æ–¥ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - –®–∞–≥ 3: –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è (—Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
   - **–ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞** (`/login <server> <user> <pass>`) ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
4. –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Rocket.Chat, —à–∏—Ñ—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
5. –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–æ–ª–µ `loginState` –≤ MongoDB

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. `RocketChatPollingService` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω Rocket.Chat
   - –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `GET /api/v1/subscriptions.get`
   - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (–∫–∞–Ω–∞–ª—ã, –ª–∏—á–Ω—ã–µ, –≥—Ä—É–ø–ø—ã)
   - –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω—ã–π Telegram —á–∞—Ç
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `lastUnread` –≤ –ë–î
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π >50, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å BullMQ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ common/           # –û–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã (CryptoService –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
‚îú‚îÄ‚îÄ database/         # MongoDB –º–æ–¥—É–ª–∏ –∏ —Å—Ö–µ–º—ã (MongoModule, User schema)
‚îú‚îÄ‚îÄ queue/            # BullMQ –æ—á–µ—Ä–µ–¥–∏ (QueueModule, PollingProcessor, QueueService)
‚îú‚îÄ‚îÄ bot/              # Telegram Bot –º–æ–¥—É–ª—å (BotModule, BotService)
‚îú‚îÄ‚îÄ user/             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (UserModule, UserService)
‚îú‚îÄ‚îÄ rocket-chat/      # Rocket.Chat API (RocketChatService, PollingService)
‚îú‚îÄ‚îÄ telegram/         # Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (TelegramService)
‚îî‚îÄ‚îÄ app.module.ts     # –ö–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å
```

## –ú–æ–¥—É–ª–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã

### Core –º–æ–¥—É–ª–∏
- **`AppModule`** ‚Äî –∫–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –º–æ–¥—É–ª–∏
- **`MongoModule`** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å MongoDB
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MongooseModule.forRootAsync` —Å `ConfigService`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `MongooseModule` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö
- **`ConfigModule`** ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ `AppModule`)
- **`QueueModule`** ‚Äî –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å BullMQ/Redis
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
  - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—á–µ—Ä–µ–¥—å `polling` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `QueueService` –∏ `PollingProcessor`

### Common –º–æ–¥—É–ª–∏
- **`CommonModule`** ‚Äî –æ–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `CryptoService` –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- **`CryptoService`** ‚Äî —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ Rocket.Chat
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AES-256-GCM —Å —Å–æ–ª—å—é –∏–∑ `RC_TOKEN_SALT`
  - –ú–µ—Ç–æ–¥—ã: `encrypt(text)`, `decrypt(encryptedText)`

### Telegram
- **`BotModule`** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegraf –±–æ—Ç–∞
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TelegrafModule.forRootAsync` —Å `ConfigService`
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç webhook (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã `TELEGRAM_WEBHOOK_URL` –∏ `TELEGRAM_WEBHOOK_SECRET`) –∏–ª–∏ polling
  - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç `BotService` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram
- **`BotService`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Telegram –±–æ—Ç–∞:
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –≤ `onModuleInit()` (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ webhook/polling)
  - `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –∫–Ω–æ–ø–∫–æ–π "üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å"
  - `/setup` ‚Äî –∑–∞–ø—É—Å–∫ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `@Action('setup')`)
  - `/login <server> <user> <pass>` ‚Äî –±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫—Ä–µ–¥–æ–≤ Rocket.Chat (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
  - `/stop` ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `@Action('setup')` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å"
  - `@Action('cancel_setup')` ‚Äî –æ—Ç–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  - `@Hears(/^[^/].*/)` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@Update()`, `@Command()`, `@Action()`, `@Hears()` –∏–∑ `nestjs-telegraf`
  - –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∞—Å—Ç–µ—Ä–∞ —á–µ—Ä–µ–∑ `UserService` (–º–µ—Ç–æ–¥—ã `setLoginState`, `getLoginState`, `updateLoginState`, `clearLoginState`)
- **`TelegramModule`** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram Bot API
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `ConfigModule` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `ConfigService`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TelegramService`
- **`TelegramService`** ‚Äî –º–µ—Ç–æ–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
  - `sendToUser(chatId, text)` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ª–∏—á–Ω—ã–π —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `sendUnreadAlert(chatId, unreadCount, mentions?)` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö

### Rocket.Chat
- **`RocketChatModule`** ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Rocket.Chat API
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TelegramModule`, `UserModule` (—á–µ—Ä–µ–∑ `forwardRef`), `QueueModule`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `RocketChatService`
- **`RocketChatService`** ‚Äî –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Rocket.Chat:
  - `login(server, user, password)` ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `LoginResult` —Å —Ç–æ–∫–µ–Ω–∞–º–∏
  - `getSubscriptions(server, token, userId, instanceId?)` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
  - `getUnreadCount(server, token, userId, instanceId?)` ‚Äî –ø–æ–¥—Å—á—ë—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
- **`RocketChatPollingService`** ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `UserService` –∏ `QueueService`
  - –î–ª—è >50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—á–µ—Ä–µ–¥—å BullMQ, –∏–Ω–∞—á–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### User management
- **`UserModule`** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `MongooseModule.forFeature` —Å User —Å—Ö–µ–º–æ–π, `RocketChatModule` (—á–µ—Ä–µ–∑ `forwardRef`), `CommonModule`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `UserService`
- **`UserService`** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î:
  - `findOrCreateTelegramUser(telegramId)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `updateRocketChatCreds(telegramId, server, user, pass)` ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Rocket.Chat, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
  - `getAllEnabledUsers()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(User & Document)[]`)
  - `updateLastUnread(userId, lastUnread)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  - `toggleEnabled(telegramId, enabled)` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - `getDecryptedToken(telegramId)` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ API
  - **–ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
    - `setLoginState(telegramId, state)` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞
    - `getLoginState(telegramId)` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞
    - `updateLoginState(telegramId, updates)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ (–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É)
    - `clearLoginState(telegramId)` ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ (–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ–Ω—ã)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `RocketChatService` (–∏–∑–±–µ–≥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

### Queue (BullMQ)
- **`QueueModule`** ‚Äî –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—è–º–∏
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis —á–µ—Ä–µ–∑ `BullModule.forRootAsync`
  - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—á–µ—Ä–µ–¥—å `polling` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á polling
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `UserModule`, `RocketChatModule` (—á–µ—Ä–µ–∑ `forwardRef`), `TelegramModule`
  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `QueueService` –∏ `BullModule`
- **`QueueService`** ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å
  - `addPollingJob(user)` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `schedulePollingForAllUsers(users)` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **`PollingProcessor`** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á –æ—á–µ—Ä–µ–¥–∏
  - `@Process('check-unread')` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `UserService` (–∏–∑–±–µ–≥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π)

### –í–µ–±-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
- **`AppController`** ‚Äî REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - `GET /` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  - `GET /healthz` ‚Äî health check (–ø—Ä–æ–≤–µ—Ä–∫–∞ MongoDB –∏ Redis)
  - `GET /users` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
  - `POST /users/:telegramId/enable` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (MongoDB + Mongoose + Typegoose)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MongoDB
- **`src/database/mongo.module.ts`** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MongooseModule.forRootAsync` —Å `ConfigService`
  - URL –ë–î –±–µ—Ä—ë—Ç—Å—è –∏–∑ `DATABASE_URL` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –°—Ö–µ–º–∞ User (Typegoose)
- **`src/database/user.schema.ts`** ‚Äî —Å—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Typegoose
```typescript
@modelOptions({ schemaOptions: { collection: 'users', timestamps: true } })
export class User extends TimeStamps {
  @prop({ required: true, unique: true })
  telegramId!: string;
  
  @prop({ required: false })
  rcServer?: string;
  
  @prop({ required: false })
  rcUser?: string;
  
  @prop({ required: false })
  rcToken?: string; // –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
  
  @prop({ required: false })
  rcUserId?: string;
  
  @prop({ required: false })
  rcInstanceId?: string;
  
  @prop({ required: true, default: 5 })
  intervalMin!: number;
  
  @prop({ required: true, default: true })
  enabled!: boolean;
  
  @prop({ required: true, default: 0 })
  lastUnread!: number;
  
  @prop({ type: Object })
  loginState?: LoginState; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (step: 'server' | 'user' | 'pass', server?, user?, createdAt)
}
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –¢–æ–∫–µ–Ω—ã Rocket.Chat —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM
- –°–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `RC_TOKEN_SALT`
- –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CryptoService.decrypt()`

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env)

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `DATABASE_URL` ‚Äî URL MongoDB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `mongodb://admin:password@localhost:27017/rocket-notify?authSource=admin`)
- `RC_TOKEN_SALT` ‚Äî —Å–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- `PORT` ‚Äî –ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3000)
- `REDIS_URL` ‚Äî URL Redis (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://localhost:6379`)
- `TELEGRAM_WEBHOOK_URL` ‚Äî URL –¥–ª—è webhook (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling)
- `TELEGRAM_WEBHOOK_SECRET` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è webhook
- `MONGO_ROOT_USERNAME` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MongoDB (–¥–ª—è docker-compose)
- `MONGO_ROOT_PASSWORD` ‚Äî –ø–∞—Ä–æ–ª—å MongoDB (–¥–ª—è docker-compose)
- `TUNA_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Tuna Tunnel (–¥–ª—è docker-compose)
- `TUNA_SUBDOMAIN` ‚Äî –ø–æ–¥–¥–æ–º–µ–Ω –¥–ª—è Tuna Tunnel (–¥–ª—è docker-compose)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ö—Ä–µ–¥—ã Rocket.Chat —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ, —Ç–æ–∫–µ–Ω—ã –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.

## Docker

### docker-compose.yml
- **MongoDB** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å MongoDB 7, –¥–∞–Ω–Ω—ã–µ –≤ `./mongo-data`
  - Health check —á–µ—Ä–µ–∑ `mongosh`
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `MONGO_ROOT_USERNAME` –∏ `MONGO_ROOT_PASSWORD`
- **Redis** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Redis 7, –¥–∞–Ω–Ω—ã–µ –≤ `./redis-data`
  - Health check —á–µ—Ä–µ–∑ `redis-cli ping`
  - Persistence —á–µ—Ä–µ–∑ `--appendonly yes`
- **App** ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ NestJS (multi-stage build)
  - Health check —á–µ—Ä–µ–∑ `GET /healthz`
  - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç MongoDB –∏ Redis (–æ–∂–∏–¥–∞–µ—Ç –∏—Ö –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `expose: 3000` –≤–º–µ—Å—Ç–æ `ports` (–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏)
- **Tuna** ‚Äî Tuna Tunnel –¥–ª—è webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `yuccastream/tuna:latest` –æ–±—Ä–∞–∑
  - –ö–æ–º–∞–Ω–¥–∞: `tuna config save-token $TUNA_TOKEN && tuna http app:3000 --subdomain=$TUNA_SUBDOMAIN`
  - –¢—Ä–µ–±—É–µ—Ç `TUNA_TOKEN` –∏ `TUNA_SUBDOMAIN` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `entrypoint: ["/bin/sh", "-c"]` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è shell –∫–æ–º–∞–Ω–¥—ã
  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ volume `tuna-config` –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (health check)
  - –°–æ–∑–¥–∞—ë—Ç –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL –≤–∏–¥–∞ `https://${TUNA_SUBDOMAIN}.tuna.am`

### Dockerfile
- Multi-stage build –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
- Production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ–±—Ä–∞–∑–µ
- –ù–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Health check –≤—Å—Ç—Ä–æ–µ–Ω –≤ –æ–±—Ä–∞–∑

### –ó–∞–ø—É—Å–∫
```bash
docker-compose up -d
```

## –¢–∏–ø–∏–∑–∞—Ü–∏—è

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- **`User`** (`src/database/user.schema.ts`) ‚Äî —Å—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Typegoose
- **`UserWithId`** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ `_id` –≤ Mongoose –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- **`LoginState`** (`src/user/login-state.interface.ts`) ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
  - `step: 'server' | 'user' | 'pass'` ‚Äî —Ç–µ–∫—É—â–∏–π —à–∞–≥ –º–∞—Å—Ç–µ—Ä–∞
  - `server?: string` ‚Äî URL —Å–µ—Ä–≤–µ—Ä–∞ Rocket.Chat (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —à–∞–≥–µ 1)
  - `user?: string` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —à–∞–≥–µ 2)
  - `createdAt: Date` ‚Äî –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **`UnreadCount`** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (`total`, `channels`, `im`, `groups`)
- **`LoginResult`** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Rocket.Chat (`authToken`, `userId`, `instanceId?`)
- **`Subscription`** ‚Äî –º–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏ Rocket.Chat (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `RocketChatService`)
- **`UserResponse`** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è REST API –æ—Ç–≤–µ—Ç–æ–≤

### –¢–∏–ø–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–º–µ—é—Ç —è–≤–Ω—ã–µ —Ç–∏–ø—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `(User & Document)[]` –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Mongoose –∑–∞–ø—Ä–æ—Å–æ–≤
- `import type` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–∏–ø–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–æ–ª—å–∫–æ –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Queue`)

## –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef()` –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

- **`UserModule` ‚Üî `RocketChatModule`** ‚Äî –æ–±–∞ –º–æ–¥—É–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç `forwardRef` –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
- **`UserService` ‚Üî `RocketChatService`** ‚Äî `UserService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@Inject(forwardRef(() => RocketChatService))`
- **`RocketChatPollingService` ‚Üî `UserService`** ‚Äî `RocketChatPollingService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@Inject(forwardRef(() => UserService))`
- **`QueueModule` ‚Üî `UserModule`** ‚Äî `QueueModule` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef(() => UserModule)`
- **`QueueModule` ‚Üî `RocketChatModule`** ‚Äî `QueueModule` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `forwardRef(() => RocketChatModule)`
- **`PollingProcessor` ‚Üî `UserService`** ‚Äî `PollingProcessor` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@Inject(forwardRef(() => UserService))`

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **NestJS 11** ‚Äî —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **MongoDB 7** ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Mongoose 9** ‚Äî ODM –¥–ª—è MongoDB
- **Typegoose 13** ‚Äî —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è Mongoose
- **BullMQ 4** ‚Äî –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ Redis
- **Redis 7** ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π
- **nestjs-telegraf** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram Bot API
- **Axios** ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Rocket.Chat API
- **TypeScript** ‚Äî —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Docker** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Docker Compose** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `Logger` –∏–∑ NestJS:

- **`RocketChatService`** ‚Äî –ª–æ–≥–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—à–∏–±–æ–∫
- **`BotService`** ‚Äî –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook, –æ—à–∏–±–æ–∫ –∫–æ–º–∞–Ω–¥
- **`RocketChatPollingService`** ‚Äî –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ polling, –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **`UserService`** ‚Äî –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–æ–≤
- **`TelegramService`** ‚Äî –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **`QueueService`** ‚Äî –ª–æ–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å
- **`PollingProcessor`** ‚Äî –ª–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á –æ—á–µ—Ä–µ–¥–∏

–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –æ—à–∏–±–∫–∏

## Health Checks

- **`GET /healthz`** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB (readyState)
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis (ping)
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `ok` –∏–ª–∏ `degraded` —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

## Graceful Shutdown

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã `SIGTERM` –∏ `SIGINT`:
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (MongoDB, Redis)
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ó–∞–ø—É—Å–∫

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
npm run start:dev
```

### Production
```bash
npm run build
npm run start:prod
```

### Docker
```bash
docker-compose up -d
```

### –õ–∏–Ω—Ç–µ—Ä
```bash
npm run lint
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1. –ù–∞–π—Ç–∏ –±–æ—Ç–∞ –≤ Telegram: `@RocketNotifyBot`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–Ω–æ–ø–∫—É "üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å"
3. –í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
   - **–ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
     - –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å" –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/setup`
     - –í–≤–µ—Å—Ç–∏ URL —Å–µ—Ä–≤–µ—Ä–∞ Rocket.Chat (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://rocketchat.example.com`)
     - –í–≤–µ—Å—Ç–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `john.doe`)
     - –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å (—Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è)
   - **–ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞** (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±):
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/login <server> <user> <pass>`
     - –ü—Ä–∏–º–µ—Ä: `/login https://rocketchat.medcontrol.cloud john pass123`
4. –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–∏—á–Ω—ã–π —á–∞—Ç –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/stop` –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `GET /healthz` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- `GET /users` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `POST /users/:telegramId/enable` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### Trust Proxy –∏ CORS
- **`main.ts`** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ –ø—Ä–æ–∫—Å–∏ (Tuna Tunnel)
  - `app.setGlobalPrefix('')` ‚Äî –ø—É—Å—Ç–æ–π –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
  - `app.enableCors()` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ CORS –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - `expressApp.set('trust proxy', true)` ‚Äî –¥–æ–≤–µ—Ä–∏–µ –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –ø—Ä–æ–∫—Å–∏ (X-Forwarded-*)
  - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã webhook —á–µ—Ä–µ–∑ Tuna Tunnel

### Webhook vs Polling
- **Polling** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –±–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É Telegram
  - –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  - –õ–æ–≥–∏: `üì° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling —Ä–µ–∂–∏–º (webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `bot.launch()` –≤ `BotService.onModuleInit()`
- **Webhook** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  - –¢—Ä–µ–±—É–µ—Ç `TELEGRAM_WEBHOOK_URL` –∏ `TELEGRAM_WEBHOOK_SECRET`
  - –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Tuna Tunnel –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ HTTPS URL
  - Endpoint: `/webhook/rocketnotify`
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è endpoint –≤ `main.ts`:
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `expressApp.post('/webhook/rocketnotify', webhookMiddleware)`
    - `webhookMiddleware` —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `bot.webhookCallback(webhookPath, { secretToken })`
    - Endpoint —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –î–û –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (`app.listen()`)
  - –í `BotModule` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `launchOptions: false` –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ polling
  - Webhook —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `bot.telegram.setWebhook()` –≤ `BotService.onModuleInit()`
  - –õ–æ–≥–∏: `‚úÖ Webhook endpoint –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: POST /webhook/rocketnotify`

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ò–Ω—Ç–µ—Ä–≤–∞–ª polling —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ `intervalMin` –≤ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –¢–æ–∫–µ–Ω—ã Rocket.Chat —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM
- `X-Instance-Id` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `lastUnread`)
- –î–ª—è >50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å BullMQ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Webhook –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Tuna Tunnel (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling)
- `MongoModule` —è–≤–ª—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `BotService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@Update()`, `@Command()`, `@Action()`, `@Hears()` –∏–∑ `nestjs-telegraf` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Telegram –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- Typegoose —Å—Ö–µ–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `MongooseModule.forFeature` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `getModelForClass(User).schema`
- `trust proxy` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `main.ts` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞ Tuna Tunnel
- Tuna Tunnel –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–∞–Ω–¥—É `tuna http app:3000 --subdomain=$TUNA_SUBDOMAIN` –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `docker-compose up -d`, Tuna —Å–æ–∑–¥–∞—Å—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∏–¥–∞ `https://${TUNA_SUBDOMAIN}.tuna.am`
- –≠—Ç–æ—Ç URL –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≤ `TELEGRAM_WEBHOOK_URL` (–±–µ–∑ –ø—É—Ç–∏, –ø—É—Ç—å `/webhook/rocketnotify` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- Webhook endpoint —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `main.ts` —á–µ—Ä–µ–∑ `expressApp.post()` –î–û –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- `BotService.onModuleInit()` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook —á–µ—Ä–µ–∑ `bot.telegram.setWebhook()` —Å –ø–æ–ª–Ω—ã–º URL –≤–∫–ª—é—á–∞—è –ø—É—Ç—å